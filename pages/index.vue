<template>
    <section
        class="v-index app-page"
        ref="elementToScale"
    >
        <div class="v-index__menu app-page__menu"
             ref="elementForSize"
        >
            <div class="v-index__menu__header">
                <AppHeader/>
            </div>
            <div class="v-index__menu__text" v-if="xlsxContent">

                <AppTextContentFoodLab color="#37007d">
                  {{ xlsxContent[1][1] }}
                  <br>{{ xlsxContent[2][1] }}
                  <br>{{ xlsxContent[3][1] }}
                  <br>&nbsp;
                </AppTextContentFoodLab>


                <AppTextContentFoodLab color="#37007d">
                  {{ xlsxContent[4][1] }}
                  <br>{{ xlsxContent[5][1] }}
                  <br>{{ xlsxContent[6][1] }}
                  <br>&nbsp;
                </AppTextContentFoodLab>


                <AppTextContentFoodLab color="#37007d">
                  {{ xlsxContent[7][1] }}
                  <br>{{ xlsxContent[8][1] }}
                  <br>{{ xlsxContent[9][1] }}
                  <br>&nbsp;
                </AppTextContentFoodLab>


                <AppTextContentFoodLab color="#37007d">
                  {{ xlsxContent[10][1] }}
                  <br>{{ xlsxContent[11][1] }}
                  <br>{{ xlsxContent[12][1] }}
                  <br>&nbsp;
                </AppTextContentFoodLab>


                <AppTextContentFoodLab color="#37007d">
                  {{ xlsxContent[13][1] }}
                  <br>{{ xlsxContent[14][1] }}
                  <br>{{ xlsxContent[15][1] }}
                  <br>&nbsp;
                </AppTextContentFoodLab>
            </div>
            <div class="v-index__menu__bg">
                <AppSvgFoodLab/>
            </div>
        </div>
    </section>
</template>





<script setup lang="ts">
import {nextTick, onBeforeUnmount, onMounted, ref, type Ref, type UnwrapRef} from 'vue'
import readXlsxFile, {type Row} from "read-excel-file";
import AppHeader from "../components/AppHeader.vue";
import AppTextContentFoodLab from "../components/AppTextContentFoodLab.vue";
import AppSvgFoodLab from "../components/AppSvgFoodLab.vue";
import {scaleTransform} from "~/utils/scaleTransform";
import {useRouter} from "#app";

const xlsxContent: Ref<Row[] | null> = ref(null)

const elementToScale: Ref<UnwrapRef<null | HTMLElement>> = ref(null)
const elementForSize: Ref<UnwrapRef<null | HTMLElement>> = ref(null)

function isEvenWeek(date: Date): boolean {
    const startOfYear = new Date(date.getFullYear(), 0, 1); // Premier jour de l'année
    const dayOfYear = Math.floor((date.getTime() - startOfYear.getTime()) / (1000 * 60 * 60 * 24)) + 1; // Numéro du jour dans l'année

    // Numéro de la semaine selon ISO 8601
    const weekNumber = Math.ceil((dayOfYear + startOfYear.getDay() - 1) / 7);

    return weekNumber % 2 === 0; // true si paire, false sinon
}


onMounted(() => {

    const dateRef = new Date()

    if(useRouter().currentRoute.value.query.next) {
        dateRef.setDate(dateRef.getDay() + 7)
    }

    fetch('https://hosting.for-pro.ch/foodlab.xlsx')
        .then(response => response.blob())
        .then(blob => readXlsxFile(blob, {
            sheet: isEvenWeek(dateRef) ? 2 : 1
        }))
        .then((rows) => {
            xlsxContent.value = rows
        }).catch(() => {
          xlsxContent.value = null
        })

    nextTick(() => {
        setPageScale()
        window.addEventListener('resize', setPageScale)
    })
})

function setPageScale() {
    if(elementToScale.value && elementForSize.value) scaleTransform({
        elementToScale: elementToScale.value,
        elementForSize: elementForSize.value
    })
}

onBeforeUnmount(() => {
    window.removeEventListener('resize', setPageScale)
})


</script>





<style lang="scss" scoped >

@media screen {
  :global(body) {
    background: var(--app-color--orange);
  }
}

.v-index__menu__header {
    position: absolute;
    top: 5.75cm;
    width: 100%;
}

.v-index__menu__text {
    position: absolute;
    top: 10.175cm;
    left: 7.65cm;
    height: 141.1mm;
    width: 12cm;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    //transform: translate(-2cm, 0);
}

.v-index__menu__bg {
    user-select: none;
    pointer-events: none;
    width: 100%;
    height: 100%;
}
</style>
